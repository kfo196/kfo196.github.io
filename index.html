<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>مشروع التخرج — نسخة محسّنة وموثوقة</title>
  <!-- CDN: Chess.js + Chessboard.js (نسخة ثابتة) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/css/chessboard.min.css" integrity="sha512-UaQmQ0cN9+0wK6Y8e1s1/PqQq6q0JKYw7Gqz0t2g6Y1fV+qQ1b5x1k2KZg8J+Yx1l2Z3c==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{
      --accent:#9b5de5; --dark:#0d0d0d; --muted:#c4b5fd; --card:#0f0f12;
      font-family: Tahoma, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(135deg,#0d0d0d,#1a0033);color:#fff;line-height:1.6;overflow-x:hidden;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{background:#121212;box-shadow:0 2px 18px rgba(155,93,229,0.6);position:sticky;top:0;z-index:10}
    .nav{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
    .logo{background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;font-weight:700;box-shadow:0 0 12px var(--accent)}
    nav ul{display:flex;list-style:none;gap:12px;padding:0;margin:0;align-items:center}
    nav a{color:#fff;text-decoration:none;font-weight:700;cursor:pointer}
    nav a:hover{color:var(--muted)}
    h1,h2,h3{margin:0 0 10px;color:var(--accent)}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 0 22px rgba(155,93,229,0.18);margin-bottom:20px}
    button{padding:8px 14px;border:0;border-radius:8px;background:var(--accent);color:#fff;font-weight:bold;cursor:pointer;transition:transform .18s,box-shadow .18s}
    button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(155,93,229,0.12)}
    input, textarea {width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #333;background:#0b0b0b;color:#fff}
    #ipResult{margin-top:10px;font-weight:bold;color:var(--muted)}

    /* Popup common */
    .popup-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;opacity:0;transition:opacity .25s ease}
    .popup-overlay.show{display:flex;opacity:1}
    .popup{background:#0f0f12;padding:18px;border-radius:12px;max-width:1100px;width:95%;color:#fff;box-shadow:0 0 24px rgba(155,93,229,0.6);position:relative;}
    .close-btn{position:absolute;top:10px;left:10px;background:#222;border:0;color:#fff;border-radius:50%;width:32px;height:32px;cursor:pointer;font-weight:bold}

    /* XO */
    .board-xo{display:grid;grid-template-columns:repeat(3,100px);gap:8px;justify-content:center}
    .cell{width:100px;height:100px;background:#121212;border-radius:8px;font-size:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:inset 0 0 0 2px rgba(255,255,255,0.02)}
    .status{margin-top:10px;color:var(--muted);text-align:center}
    .scores{display:flex;gap:10px;justify-content:center;margin-top:8px}

    /* Chess */
    .chess-grid{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}
    .info-box{background:#0b0b0b;border-radius:8px;padding:12px}
    .tutorial{margin-top:10px}
    .tutorial .piece{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .small{font-size:14px;color:var(--muted)}
    .highlight{background:radial-gradient(circle at 30% 30%, rgba(155,93,229,0.18), rgba(0,0,0,0));}

    @media (max-width:900px){
      .chess-grid{grid-template-columns:1fr}
      .board-xo{grid-template-columns:repeat(3,80px);gap:6px}
      .cell{width:80px;height:80px;font-size:34px}
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="logo">🔒 مشروع التخرج — نهائي</div>
      <nav>
        <ul>
          <li><a href="#about">عن المشروع</a></li>
          <li><a id="openXO">🎮 إلعب XO</a></li>
          <li><a id="openChess">♟️ إلعب الشطرنج</a></li>
          <li><a href="#ipSection">🔐 عن الـIP</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section id="about" class="card">
      <h1>مشروع التخرج — نسخة محسّنة وموثوقة</h1>
      <p>التخصص: <strong>الأمن السيبراني</strong> — إعداد: <strong>حمود عبد الكريم</strong></p>
      <p>هذه النسخة تحسن كل الميزات: واجهة أكثر ثباتًا، لعبة XO محسّنة، لعبة شطرنج جاهزة للعب مع وضع تعليمي تفاعلي وذكاء اصطناعي مخصّص، وفصل أفضل للكود وسيناريوهات فشل الشبكة.</p>
    </section>

    <section id="ipSection" class="card">
      <h2>🔐 ما هو الـ IP؟</h2>
      <button onclick="getIP()">اعرض عنوان IP الخاص بي</button>
      <div id="ipResult"></div>
    </section>
  </main>

  <footer class="container" style="text-align:center;color:var(--muted);padding:20px 0">
    &copy; 2025 — كليات بريدة — الطالب حمود عبد الكريم
  </footer>

  <!-- XO Popup -->
  <div class="popup-overlay" id="popupXO">
    <div class="popup">
      <button class="close-btn" data-target="popupXO">✖</button>
      <h2>لعبة XO — محسّنة</h2>
      <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start;justify-content:center">
        <div>
          <div class="board-xo" id="xoBoard">
            <div class="cell" data-i="0"></div>
            <div class="cell" data-i="1"></div>
            <div class="cell" data-i="2"></div>
            <div class="cell" data-i="3"></div>
            <div class="cell" data-i="4"></div>
            <div class="cell" data-i="5"></div>
            <div class="cell" data-i="6"></div>
            <div class="cell" data-i="7"></div>
            <div class="cell" data-i="8"></div>
          </div>
          <p class="status" id="xoStatus">دورك الآن</p>
          <div class="scores">
            <div class="info-box small">أنت: <span id="scorePlayer">0</span></div>
            <div class="info-box small">الـAI: <span id="scoreAI">0</span></div>
            <div class="info-box small">تعادلات: <span id="scoreDraw">0</span></div>
          </div>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
            <button id="resetXO">إعادة</button>
            <button id="toggleAIFirst">اجعل الـAI يبدأ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chess Popup -->
  <div class="popup-overlay" id="popupChess">
    <div class="popup" style="max-width:1100px">
      <button class="close-btn" data-target="popupChess">✖</button>
      <h2>♟️ لعبة الشطرنج — تعلم و العب</h2>
      <div class="chess-grid">
        <div>
          <div id="board" style="width:100%"></div>
        </div>
        <div>
          <div class="info-box">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small">الوضع: <strong id="gameStatusText">اللاعب ضد الكمبيوتر</strong></div>
                <div class="small">الدور: <strong id="turnText">أبيض</strong></div>
              </div>
              <div style="display:flex;gap:8px">
                <button id="newGameChess">جديد</button>
                <button id="undoMove">تراجع</button>
                <button id="toggleTutorial">وضع التعلّم</button>
              </div>
            </div>

            <div class="tutorial" id="tutorialArea" style="display:none;margin-top:12px">
              <h3 class="small">تعلم تحريك القطع</h3>
              <div class="piece"><div style="font-size:22px">♔</div><div><strong>الملك</strong> — مربع واحد في أي اتجاه.</div></div>
              <div class="piece"><div style="font-size:22px">♕</div><div><strong>الوزير</strong> — أي اتجاه بعدد مربعات غير محدود.</div></div>
              <div class="piece"><div style="font-size:22px">♖</div><div><strong>القلعة</strong> — أفقياً أو عمودياً بعدد مربعات غير محدود.</div></div>
              <div class="piece"><div style="font-size:22px">♗</div><div><strong>الفيل</strong> — قطريًا بعدد مربعات غير محدود.</div></div>
              <div class="piece"><div style="font-size:22px">♘</div><div><strong>الحصان</strong> — بشكل L (2 + 1).</div></div>
              <div class="piece"><div style="font-size:22px">♙</div><div><strong>البيادق</strong> — إلى الأمام مربع واحد (أو مربعين في المسار الأول)، وتأسر قطريًا.</div></div>
              <div class="small" style="margin-top:8px">انقر أو حرّك مؤشر الفأرة فوق قطعة لرؤية الحركات الممكنة. في وضع التعلّم النقل معطّل لتتعلم بدون تغيير الوضع.</div>
            </div>

            <div id="moveLog" style="margin-top:10px;max-height:220px;overflow:auto;background:#070707;padding:8px;border-radius:6px;font-size:13px"></div>
            <div id="errorBox" style="margin-top:10px;color:#ffb4c0;display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- مكتبات خارجية -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/js/chessboard.min.js"></script>

  <script>
    // ======= Helpers: فتح/إغلاق النوافذ =======
    function showPopup(id){ const el=document.getElementById(id); el.style.display='flex'; setTimeout(()=>el.classList.add('show'),10); }
    function hidePopup(id){ const el=document.getElementById(id); el.classList.remove('show'); setTimeout(()=>{ el.style.display='none'; },260); }
    document.getElementById('openXO').onclick = ()=> showPopup('popupXO');
    document.getElementById('openChess').onclick = ()=> { showPopup('popupChess'); initChess(); };
    document.querySelectorAll('.close-btn').forEach(b=>b.addEventListener('click', e=>{ const t=b.getAttribute('data-target'); if(t) hidePopup(t); }));

    // ================= XO =================
    const xoCells = document.querySelectorAll('#xoBoard .cell');
    let xoBoard = Array(9).fill(null);
    let xoPlayer = 'X', xoAI = 'O', xoTurn = 'X', xoGameOver = false;
    let scorePlayer = 0, scoreAI = 0, scoreDraw = 0, xoAIFirst = false;

    function updateXOScores(){ document.getElementById('scorePlayer').textContent = scorePlayer; document.getElementById('scoreAI').textContent = scoreAI; document.getElementById('scoreDraw').textContent = scoreDraw; }
    function xoMakeMove(i,s){ xoBoard[i] = s; xoCells[i].textContent = s; }
    function xoCheckWinner(b){ const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; for(const [a,c,d] of lines) if(b[a] && b[a]===b[c] && b[a]===b[d]) return b[a]; return null; }
    function xoAfterMove(){ const w = xoCheckWinner(xoBoard); if(w){ xoEnd(w); return; } if(xoBoard.every(x=>x)){ xoEnd('draw'); return; } xoTurn = (xoTurn==='X') ? 'O' : 'X'; document.getElementById('xoStatus').textContent = (xoTurn===xoPlayer) ? 'دورك الآن' : 'جاري تفكير الـAI...'; if(xoTurn===xoAI){ setTimeout(()=>{ const best = findBestMoveXO([...xoBoard], xoAI); xoMakeMove(best.index, xoAI); xoAfterMove(); }, 250); } }
    function xoEnd(result){ xoGameOver = true; if(result==='draw'){ document.getElementById('xoStatus').textContent = 'تعادل!'; scoreDraw++; } else if(result===xoPlayer){ document.getElementById('xoStatus').textContent = 'فزت 🎉'; scorePlayer++; } else { document.getElementById('xoStatus').textContent = 'الـAI فاز 😅'; scoreAI++; } updateXOScores(); setTimeout(xoReset,900); }
    function xoReset(){ xoBoard = Array(9).fill(null); xoCells.forEach(c=>c.textContent=''); xoGameOver=false; xoTurn='X'; document.getElementById('xoStatus').textContent='دورك الآن'; if(xoAIFirst){ xoTurn = xoAI; setTimeout(()=>{ const best = findBestMoveXO([...xoBoard], xoAI); xoMakeMove(best.index, xoAI); xoAfterMove(); }, 250); } }

    xoCells.forEach(cell=> cell.addEventListener('click', ()=>{ const i = Number(cell.dataset.i); if(xoGameOver || xoBoard[i] || xoTurn!==xoPlayer) return; xoMakeMove(i, xoPlayer); xoAfterMove(); }));
    document.getElementById('resetXO').addEventListener('click', xoReset);
    document.getElementById('toggleAIFirst').addEventListener('click', ()=>{ xoAIFirst = !xoAIFirst; document.getElementById('toggleAIFirst').textContent = xoAIFirst ? 'الـAI يبدأ' : 'اجعل الـAI يبدأ'; xoReset(); });

    // Minimax XO
    function minimaxXO(board, depth, isMax){ const winner = xoCheckWinner(board); if(winner===xoAI) return 10-depth; if(winner===xoPlayer) return depth-10; if(board.every(x=>x)) return 0; if(isMax){ let best = -Infinity; for(let i=0;i<9;i++) if(!board[i]){ board[i]=xoAI; best = Math.max(best, minimaxXO(board, depth+1, false)); board[i]=null; } return best; } else { let best = Infinity; for(let i=0;i<9;i++) if(!board[i]){ board[i]=xoPlayer; best = Math.min(best, minimaxXO(board, depth+1, true)); board[i]=null; } return best; } }
    function findBestMoveXO(bState, aiSymbol){ let bestVal = -Infinity, moveIndex = 0; for(let i=0;i<9;i++){ if(!bState[i]){ bState[i] = aiSymbol; const val = minimaxXO(bState,0,false); bState[i] = null; if(val > bestVal){ bestVal = val; moveIndex = i; } } } return { index: moveIndex }; }

    // ================= IP =================
    async function getIP(){ const resultEl = document.getElementById('ipResult'); resultEl.textContent = 'جاري الجلب...'; try{ const res = await fetch('https://api.ipify.org?format=json'); if(!res.ok) throw new Error('فشل الاستجابة'); const data = await res.json(); resultEl.textContent = 'عنوان IP الخاص بك: ' + data.ip; }catch(e){ resultEl.textContent = 'حدث خطأ أثناء جلب عنوان الـ IP — تحقق من اتصالك أو حاول لاحقًا.'; } }

    // ================= Chess =================
    let boardObj = null, chess = null, tutorialOn = false, aiThinking = false, chessInitialised = false;

    function initChess(){
      const errBox = document.getElementById('errorBox'); errBox.style.display='none';
      if(chessInitialised) return; // نهيئ مرة واحدة

      // تحقق من وجود المكتبات
      if(typeof Chess === 'undefined' || typeof Chessboard === 'undefined'){
        errBox.style.display='block'; errBox.textContent = 'فشل تحميل مكتبات الشطرنج من الـCDN. تأكد من اتصال الإنترنت أو استخدم نسخ محلية.'; return;
      }

      chessInitialised = true;
      chess = new Chess();

      const cfg = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoverSquare: onMouseoverSquare,
        onMouseoutSquare: onMouseoutSquare,
        onSnapEnd: onSnapEnd
      };

      boardObj = Chessboard('board', cfg);
      updateStatus();

      document.getElementById('newGameChess').addEventListener('click', ()=>{ chess.reset(); boardObj.position(chess.fen()); updateStatus(); });
      document.getElementById('undoMove').addEventListener('click', ()=>{ chess.undo(); boardObj.position(chess.fen()); updateStatus(); });
      document.getElementById('toggleTutorial').addEventListener('click', ()=>{ tutorialOn = !tutorialOn; document.getElementById('tutorialArea').style.display = tutorialOn ? 'block' : 'none'; });
    }

    function onDragStart(source, piece, position, orientation){
      if(tutorialOn){ // في وضع التعلّم منع النقل، مع إبراز الحركات
        const moves = chess.moves({ square: source, verbose: true }); if(moves.length === 0) return false; return false; }
      if(chess.game_over()) return false;
      if((chess.turn() === 'w' && piece.search(/^b/) !== -1) || (chess.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
    }

    function onDrop(source, target){
      removeHighlights();
      const move = chess.move({ from: source, to: target, promotion: 'q' });
      if(move === null) return 'snapback';
      boardObj.position(chess.fen()); logMove(move); updateStatus();
      if(!chess.game_over()) setTimeout(()=>{ aiMakeMove(); }, 300);
    }

    function onMouseoverSquare(square, piece){ if(!tutorialOn) return; const moves = chess.moves({ square: square, verbose: true }); if(moves.length === 0) return; greySquare(square); moves.forEach(m => greySquare(m.to)); }
    function onMouseoutSquare(square, piece){ if(!tutorialOn) return; removeHighlights(); }
    function onSnapEnd(){ boardObj.position(chess.fen()); }

    function greySquare(square){ const sqEl = document.querySelector('#board .square-' + square); if(sqEl) sqEl.classList.add('highlight'); }
    function removeHighlights(){ const els = document.querySelectorAll('#board .square-55d63'); els.forEach(el=>el.classList.remove('highlight')); }

    function updateStatus(){ const statusText = document.getElementById('gameStatusText'); const turnText = document.getElementById('turnText'); let status = ''; const moveColor = (chess.turn() === 'w') ? 'أبيض' : 'أسود'; turnText.textContent = moveColor; if(chess.in_checkmate()) status = 'كش مات — انتهت اللعبة'; else if(chess.in_draw()) status = 'تعادل — انتهت اللعبة'; else if(chess.in_check()) status = 'كش — اللاعب تحت التهديد'; else status = 'نشطة'; statusText.textContent = 'اللاعب ضد الكمبيوتر — الحالة: ' + status; // سجل الحركات
      const history = chess.history({ verbose: true }); const log = document.getElementById('moveLog'); log.innerHTML = ''; history.forEach((m,i)=>{ const p = document.createElement('div'); p.textContent = (i+1)+'. ' + m.san; log.appendChild(p); }); log.scrollTop = log.scrollHeight; }

    function logMove(move){ /* يمكن تحسين تسجيل الحركات هنا */ }

    // ======= AI للشطرنج =======
    const pieceValue = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };
    function evaluateBoard(game){ let total = 0; const b = game.board(); for(let r=0;r<8;r++) for(let f=0;f<8;f++){ const p = b[r][f]; if(p){ const val = pieceValue[p.type] || 0; total += (p.color === 'w') ? val : -val; } } return total; }

    function minimax(game, depth, alpha, beta, isMax){ if(depth === 0 || game.game_over()) return evaluateBoard(game); const moves = game.moves(); if(isMax){ let maxEval = -Infinity; for(const m of moves){ game.move(m); const eval = minimax(game, depth-1, alpha, beta, false); game.undo(); if(eval > maxEval) maxEval = eval; if(eval > alpha) alpha = eval; if(beta <= alpha) break; } return maxEval; } else { let minEval = Infinity; for(const m of moves){ game.move(m); const eval = minimax(game, depth-1, alpha, beta, true); game.undo(); if(eval < minEval) minEval = eval; if(eval < beta) beta = eval; if(beta <= alpha) break; } return minEval; } }

    function aiMakeMove(){ if(aiThinking) return; aiThinking = true; const depth = 2; let bestMove = null; let bestEval = -Infinity; const moves = chess.moves(); for(const m of moves){ chess.move(m); const eval = minimax(chess, depth-1, -Infinity, Infinity, false); chess.undo(); if(eval > bestEval){ bestEval = eval; bestMove = m; } } if(bestMove){ chess.move(bestMove); boardObj.position(chess.fen()); logMove(bestMove); updateStatus(); } aiThinking = false; }

    // بدءيات
    (function ready(){ document.getElementById('toggleAIFirst').textContent = 'اجعل الـAI يبدأ'; })();
  </script>
</body>
</html>
